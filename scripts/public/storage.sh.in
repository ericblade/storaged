#!/bin/bash

# @@@LICENSE
#
#      Copyright (c) 2002-2013 LG Electronics, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# LICENSE@@@

DbgPrint() {
    #echo "$@" > /dev/null
    logger -t udev_storaged -p debug "$@"
}

ErrPrint() {
    logger -t udev_storaged -p err "$@"
}

DbgPrint "$0($1,$2,$3,$4,$5) called: "

ACTION="$1"
MEDIA_LOADED="$2"
HOST_CONNECTED="$3"
MEDIA_REQUESTED="$4"
BUS_SUSPENDED="$5"
CHANGE="${MEDIA_LOADED}${HOST_CONNECTED}${MEDIA_REQUESTED}${BUS_SUSPENDED}"

if [ "$ACTION" == "HOST_STATE_CHANGED" ]; then
    method="changed"
    change_name="connected"
elif [ "$ACTION" == "MEDIA_STATE_CHANGED" ]; then
    method="avail"
    change_name="connected"
elif [ "$ACTION" == "MEDIA_REQUEST_STATE_CHANGED" ]; then
    method="requestMedia"
    change_name="connected"
elif [ "$ACTION" == "BUS_STATE_CHANGED" ]; then
    method="busSuspended"
    change_name="suspended"
else
    ErrPrint "unknown action $ACTION passed to $0"
    return
fi

# TODO: If more than one of the change variables is set, this script will not know how to deal with it.  It never has known, though.
# Probably need to check with a Legacy webOS device, to see how it handled this situation, and model something after that.
if [ "$CHANGE" == "0" ]; then
    MESSAGE="{\"$change_name\": false}"
elif [ "$CHANGE" == "1" ]; then
    MESSAGE="{\"$change_name\": true}"
else
    ErrPrint "unexpected change $CHANGE passed to $0"
    return
fi

# TODO: use luna-helper rather than luna-send here
DbgPrint "@WEBOS_INSTALL_BINDIR@/luna-send -n 1 luna://com.palm.storage/diskmode/$method \"$MESSAGE\""
@WEBOS_INSTALL_BINDIR@/luna-send -n 1 luna://com.palm.storage/diskmode/$method "$MESSAGE"
